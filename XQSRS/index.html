<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>成绩管理系统</title>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #1890ff 0%, #36a8ff 100%);
            --primary-color: #1890ff;
            --secondary-color: #36a8ff;
            --success-color: #52c41a;
            --warning-color: #faad14;
            --error-color: #ff4d4f;
            --border-color: #404040;
            --background-color: #141414;
            --component-background: #1f1f1f;
            --text-color: #d9d9d9;
            --text-secondary: #8c8c8c;
        }
        
        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            line-height: 1.8;
            color: var(--text-color);
            background: var(--background-color);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            background: var(--component-background);
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-size: 28px;
            color: var(--text-color);
            margin-bottom: 32px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--primary-color);
            position: relative;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100px;
            height: 2px;
            background: var(--primary-gradient);
        }

        .form-group {
            background: var(--component-background);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.03);
            transition: all 0.3s ease;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
            transform: translateY(-2px);
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        label {
            font-weight: 500;
            color: var(--text-secondary);
            min-width: 100px;
            font-size: 15px;
        }

        input[type="text"],
        input[type="number"],
        input[type="file"],
        select,
        input[readonly] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--component-background);
            color: var(--text-color);
            font-size: 14px;
            transition: all 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
            outline: none;
        }

        input[readonly] {
            background-color: var(--component-background);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .file-input-wrapper {
            margin: 24px 0;
            position: relative;
        }

        .file-input-wrapper input[type="file"] {
            width: 100%;
            padding: 20px;
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            background: rgba(24, 144, 255, 0.02);
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-input-wrapper input[type="file"]:hover {
            border-color: var(--primary-color);
            background: rgba(24, 144, 255, 0.05);
        }

        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 32px;
        }

        .primary-button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: var(--primary-gradient);
            color: white;
            font-weight: 500;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .primary-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(24, 144, 255, 0.2);
        }

        .primary-button:active {
            transform: translateY(0);
        }

        /* 添加图标 */
        .primary-button i {
            font-size: 18px;
        }

        /* 添加响应式设计 */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .form-group {
                grid-template-columns: 1fr;
            }

            .button-group {
                grid-template-columns: 1fr;
            }
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border-color: var(--border-color);
        }

        th, td {
            padding: 12px;
            text-align: center;
            border: 1px solid var(--border-color);
            background-color: var(--component-background);
        }

        th {
            font-weight: 500;
            color: var(--text-secondary);
        }

        tr:hover td {
            background: rgba(24, 144, 255, 0.02);
        }

        @media print {
            body {
                background: white;
                margin: 0;
                padding: 0;
            }
            
            .no-print {
                display: none;
            }
            
            .container {
                box-shadow: none;
                padding: 0;
                margin: 0;
            }
            
            .class-page {
                padding: 20px 30px;
                page-break-after: always;
                page-break-inside: avoid;
            }
            
            table {
                width: 100%;
                border-collapse: collapse;
                margin: 10px 0;
            }
            
            th, td {
                padding: 6px 4px;
                font-size: 12px;
                border: 1px solid #000;
                text-align: center;
            }
            
            h2 {
                margin: 10px 0;
                font-size: 16px;
                text-align: center;
                font-weight: bold;
            }

            .statistics-table th {
                background-color: #f0f0f0 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            tr:last-child {
                font-weight: bold;
            }

            .footer-note {
                margin-top: 15px;
                font-size: 12px;
            }

            .signature-line {
                margin-top: 20px;
                display: flex;
                justify-content: space-between;
                font-size: 12px;
            }

            @page {
                margin: 0.5cm;
                size: A4 portrait;
            }

            .score-distribution {
                display: none;
            }

            .footer-note {
                font-size: 12px;
                width: 100%;
            }

            .footer-note > div {
                line-height: 1.5;
            }

            .statistics-table, .footer-note {
                width: 100%;
                table-layout: fixed;
            }

            .class-page {
                padding: 20px 30px;
            }
        }

        select {
            width: 200px;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--component-background);
            cursor: pointer;
            transition: all 0.3s;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8.825L1.175 4 2.238 2.938 6 6.7l3.763-3.762L10.825 4z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 12px;
        }

        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(24,144,255,0.2);
        }

        .score-distribution {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .score-distribution h3 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }

        .chart-container {
            background: #fafafa;
            padding: 20px;
            border-radius: 4px;
        }

        .chart-bar {
            width: 100px;
        }

        @media print {
            .score-distribution {
                display: none;
            }
            
            .chart-container {
                padding: 10px;
            }
        }

        /* 添加加载提示样式 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border-width: 3px;
        }

        .loading-text {
            font-size: 16px;
            margin-top: 16px;
        }

        @media print {
            .loading-overlay {
                display: none !important;
            }
        }
        
        /* 添加过渡效果 */
        * {
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .help-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border-radius: 24px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .help-button:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .help-icon {
            width: 20px;
            height: 20px;
        }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <a href="manual.html" target="_blank" class="help-button">
            <svg class="help-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2"/>
                <path d="M12 17V17.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M12 14C11.9816 13.1577 12.3745 12.4259 13.0441 11.8946C13.7137 11.3632 14.0484 10.7331 14.0484 10.0042C14.0484 9.25203 13.7747 8.62964 13.2272 8.13701C12.6798 7.64437 11.9926 7.39806 11.1657 7.39806C10.4148 7.39806 9.77811 7.60322 9.25559 8.01353C8.73307 8.42385 8.41775 8.96276 8.30962 9.63027" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            使用帮助
        </a>
        <div class="no-print">
            <h1>成绩管理系统</h1>
            <div class="form-group">
                <div class="input-group">
                    <label for="year">年份:</label>
                    <select id="year">
                        <option value="2025" selected>2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                        <option value="2028">2028</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="school">学校:</label>
                    <input type="text" id="school" value="西庆中学" readonly>
                </div>
            </div>
            <div class="form-group">
                <div class="input-group">
                    <label for="term">学期:</label>
                    <select id="term">
                        <option value="秋">秋学期</option>
                        <option value="春">春学期</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="exam">考试:</label>
                    <select id="exam" onchange="updateExamNumber()">
                        <option value="期中">期中</option>
                        <option value="期末" selected>期末</option>
                        <option value="月考">月考</option>
                        <option value="模拟">模拟</option>
                        <option value="custom">自定义</option>
                    </select>
                </div>
            </div>
            <div class="input-group" id="customExamGroup" style="display: none;">
                <label for="customExam">考试名称:</label>
                <input type="text" id="customExam" placeholder="如：区统测">
            </div>
            <div class="input-group" id="examNumberGroup" style="display: none;">
                <label for="examNumber">次数:</label>
                <select id="examNumber">
                    <option value="一">一</option>
                    <option value="二">二</option>
                    <option value="三">三</option>
                    <option value="四">四</option>
                    <option value="五">五</option>
                </select>
            </div>
            <div class="form-group">
                <div class="input-group">
                    <label for="subject">学科:</label>
                    <select id="subject">
                        <option value="语文">语文</option>
                        <option value="数学">数学</option>
                        <option value="英语">英语</option>
                        <option value="物理">物理</option>
                        <option value="化学">化学</option>
                        <option value="生物">生物</option>
                        <option value="政治">政治</option>
                        <option value="历史">历史</option>
                        <option value="地理">地理</option>
                        <option value="体育">体育</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <div class="input-group">
                    <label for="teacher">任课教师:</label>
                    <input type="text" id="teacher" placeholder="如：张明">
                </div>
            </div>
            <div class="actions">
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" accept=".xlsx" multiple>
                </div>
                <div class="button-group">
                    <button class="primary-button" onclick="handleGenerateAll()">
                        <i class="ri-file-list-line"></i>
                        生成所有班级成绩表
                    </button>
                    <button class="primary-button" onclick="handlePrintGrades()">
                        <i class="ri-printer-line"></i>
                        打印不包含学生成绩的等级
                    </button>
                    <button class="primary-button" onclick="handlePrintStats()">
                        <i class="ri-bar-chart-line"></i>
                        打印成绩统计
                    </button>
                    <button class="primary-button" onclick="handleExport()">
                        <i class="ri-download-line"></i>
                        导出成绩表
                    </button>
                    <button class="primary-button" onclick="handleExportStats()">
                        <i class="ri-download-cloud-line"></i>
                        导出成绩统计
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 添加加载提示 -->
        <div id="loading" style="display: none;" class="loading-overlay">
            <div class="loading-spinner"></div>
            <div class="loading-text">处理中...</div>
        </div>
        
        <div id="output"></div>
    </div>

    <script src="./lib/xlsx.full.min.js"></script>
    <script>
        // 全局变量
        let allClassData = {};

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 绑定按钮事件
            document.getElementById('btn1').addEventListener('click', function() {
                console.log('Button 1 clicked');
                handleGenerateAll();
            });

            document.getElementById('btn2').addEventListener('click', function() {
                console.log('Button 2 clicked');
                handlePrintGrades();
            });

            document.getElementById('btn3').addEventListener('click', function() {
                console.log('Button 3 clicked');
                handlePrintStats();
            });

            document.getElementById('btn4').addEventListener('click', function() {
                console.log('Button 4 clicked');
                handleExport();
            });

            document.getElementById('btn5').addEventListener('click', function() {
                console.log('Button 5 clicked');
                handleExportStats();
            });

            // 文件选择事件
            document.getElementById('fileInput').addEventListener('change', function(e) {
                console.log('Files selected:', e.target.files.length);
            });
        });

        // 处理函数
        function handleGenerateAll() {
            try {
                const files = document.getElementById('fileInput').files;
                if (files.length === 0) {
                    alert('请选择成绩文件');
                    return;
                }

                // 显示加载提示
                showLoading();

                allClassData = {};
                document.getElementById('output').innerHTML = '';

                // 使用 Promise.all 优化文件处理
                const filePromises = Array.from(files)
                    .sort((a, b) => {
                        const numA = parseInt(a.name.replace(/[^0-9]/g, ''));
                        const numB = parseInt(b.name.replace(/[^0-9]/g, ''));
                        return numA - numB;
                    })
                    .map(file => processFile(file));

                Promise.all(filePromises)
                    .then(() => {
                        generateOutput();
                        hideLoading();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('处理文件时出错：' + error.message);
                        hideLoading();
                    });
            } catch (error) {
                console.error('Error:', error);
                alert('处理出错：' + error.message);
                hideLoading();
            }
        }

        // 修改文件处理函数
        function processFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        
                        // 直接使用文件名（不包含扩展名）作为班级名称
                        const className = file.name.replace(/\.xlsx$/, '');
                        
                        // 跳过重复的表头行，从第三行开始读取数据
                        allClassData[className] = rows.slice(2).filter(row => 
                            row && row.length >= 3 && row[2] !== undefined && row[2] !== '成绩'
                        );
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // 添加加载提示控制函数
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function handlePrintGrades() {
            try {
                if (Object.keys(allClassData).length === 0) {
                    alert('请先导入成绩文件');
                    return;
                }

                let output = '';
                const sortedClasses = Object.keys(allClassData).sort((a, b) => {
                    const numA = parseInt(a.replace(/[^0-9]/g, ''));
                    const numB = parseInt(b.replace(/[^0-9]/g, ''));
                    return numA - numB;
                });

                sortedClasses.forEach(className => {
                    const studentData = allClassData[className];
                    const rowsPerPage = Math.ceil(studentData.length / 2);
                    const pages = Math.min(2, Math.ceil(studentData.length / rowsPerPage));
                    
                    for (let page = 0; page < pages; page++) {
                        const start = page * rowsPerPage;
                        const end = Math.min(start + rowsPerPage, studentData.length);
                        output += generateClassPage(className, studentData.slice(start, end), page + 1);
                    }
                });
                
                document.getElementById('output').innerHTML = output;
                window.print();
            } catch (error) {
                console.error('Error:', error);
                alert('处理出错：' + error.message);
            }
        }

        function handlePrintStats() {
            try {
                if (Object.keys(allClassData).length === 0) {
                    alert('请先导入成绩文件');
                    return;
                }

                const year = document.getElementById('year').value || "";
                const school = document.getElementById('school').value || "";
                const term = document.getElementById('term').value || "";
                const subject = document.getElementById('subject').value || "";
                const examText = getExamText();

                const output = generateStatisticsTable(year, school, term, examText, subject);
                document.getElementById('output').innerHTML = output;
                window.print();
            } catch (error) {
                console.error('Error:', error);
                alert('处理出错：' + error.message);
            }
        }

        function handleExport() {
            try {
                if (Object.keys(allClassData).length === 0) {
                    alert('请先导入成绩文件');
                    return;
                }

                const year = document.getElementById('year').value || "";
                const school = document.getElementById('school').value || "";
                const term = document.getElementById('term').value || "";
                const subject = document.getElementById('subject').value || "";
                const examText = getExamText();

                const wb = XLSX.utils.book_new();
                
                // 使用排序函数对班级进行排序
                const sortedClasses = sortClassNames(Object.keys(allClassData));
                
                // 按排序后的顺序添加工作表
                sortedClasses.forEach(className => {
                    const data = allClassData[className];
                    const wsData = [['学号', '姓名', '成绩', '等级']];
                    data.forEach(row => {
                        wsData.push([
                            row[0],
                            row[1],
                            row[2],
                            calculateGrade(row[2], (subject === "语文" || subject === "数学" || subject === "英语") ? 120 : 100)
                        ]);
                    });
                    const ws = XLSX.utils.aoa_to_sheet(wsData);
                    XLSX.utils.book_append_sheet(wb, ws, formatClassName(className));
                });
                
                XLSX.writeFile(wb, `${year}${school}${term}${examText}${subject}成绩.xlsx`);
            } catch (error) {
                console.error('Error:', error);
                alert('导出Excel时出错：' + error.message);
            }
        }

        // 修改 generateOutput 函数
        function generateOutput() {
            let output = '';
            const sortedClasses = sortClassNames(Object.keys(allClassData));
            
            sortedClasses.forEach(className => {
                output += generateClassScores(className, false);
            });
            document.getElementById('output').innerHTML = output;
        }

        function calculateGrade(score, fullScore) {
            const percentage = (score / fullScore) * 100;
            if (percentage >= 90) return 'A+';
            if (percentage >= 85) return 'A';
            if (percentage >= 80) return 'B+';
            if (percentage >= 75) return 'B';
            if (percentage >= 60) return 'C';
            if (percentage >= 30) return 'D';
            return 'E';
        }

        function generateClassScores(className, hideScores) {
            const year = document.getElementById('year').value || "";
            const school = document.getElementById('school').value || "";
            const term = document.getElementById('term').value || "";
            const subject = document.getElementById('subject').value || "";
            const examText = getExamText();

            const studentData = allClassData[className];
            let output = `<div class="class-page" style="page-break-after: always;">`;
            output += `<h2>${year}年 ${school} ${term}${examText} ${subject} ${formatClassName(className)}班考试成绩</h2>`;
            output += '<table><tr><th>学号</th><th>姓名</th>';
            if (!hideScores) output += '<th>成绩</th>';
            output += '<th>等级</th></tr>';

            studentData.forEach(([id, name, score]) => {
                const fullScore = (subject === "语文" || subject === "数学" || subject === "英语") ? 120 : 100;
                const grade = calculateGrade(score, fullScore);
                output += `<tr><td>${id}</td><td>${name}</td>`;
                if (!hideScores) output += `<td>${score}</td>`;
                output += `<td>${grade}</td></tr>`;
            });

            output += '</table></div>';
            return output;
        }

        function generateClassPage(className, data, pageNum) {
            const year = document.getElementById('year').value || "";
            const school = document.getElementById('school').value || "";
            const term = document.getElementById('term').value || "";
            const subject = document.getElementById('subject').value || "";
            const examText = getExamText();

            return `
                <div class="class-page">
                    <h2>${year}年 ${school} ${term}${examText} ${subject} ${formatClassName(className)}班学生名单（第${pageNum}页）</h2>
                    <table>
                        <tr>
                            <th>学号</th>
                            <th>姓名</th>
                            <th>等级</th>
                        </tr>
                        ${data.map(([id, name, score]) => `
                            <tr>
                                <td>${id}</td>
                                <td>${name}</td>
                                <td>${calculateGrade(score, (subject === "语文" || subject === "数学" || subject === "英语") ? 120 : 100)}</td>
                            </tr>
                        `).join('')}
                    </table>
                </div>
            `;
        }

        function generateStatisticsTable(year, school, term, examText, subject, teacher) {
            const sortedClasses = sortClassNames(Object.keys(allClassData));
            
            let output = `<div class="class-page">`;
            output += `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">${year}年 ${school} ${term}${examText} ${subject}考试成绩统计</h2>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span>统计人：</span>
                        <input type="text" id="statisticsPerson" style="width: 100px; border: none; border-bottom: 1px solid #000; text-align: center;">
                    </div>
                </div>`;
            
            // 用于计算总计
            let totalStudents = 0;
            let totalScore = 0;
            let totalPassCount = 0;
            let totalExcellentCount = 0;
            let totalLowScoreCount = 0;
            let overallHighest = 0;
            let overallLowest = 100;
            
            // 生成每个班级的统计数据
            const classStats = sortedClasses.map(className => {
                const studentData = allClassData[className];
                let classTotal = 0;
                let passCount = 0;
                let excellentCount = 0;
                let lowScoreCount = 0;
                let highestScore = 0;
                let lowestScore = 100;
                
                studentData.forEach(row => {
                    const score = row[2];
                    classTotal += score;
                    if (score >= 60) passCount++;
                    if (score >= 90) excellentCount++;
                    if (score < 30) lowScoreCount++;
                    if (score > highestScore) highestScore = score;
                    if (score < lowestScore) lowestScore = score;
                });

                // 更新总计数据
                totalStudents += studentData.length;
                totalScore += classTotal;
                totalPassCount += passCount;
                totalExcellentCount += excellentCount;
                totalLowScoreCount += lowScoreCount;
                overallHighest = Math.max(overallHighest, highestScore);
                overallLowest = Math.min(overallLowest, lowestScore);

                const averageScore = (classTotal / studentData.length).toFixed(2);
                const passRate = ((passCount / studentData.length) * 100).toFixed(2);
                const excellentRate = ((excellentCount / studentData.length) * 100).toFixed(2);
                const lowScoreRate = ((lowScoreCount / studentData.length) * 100).toFixed(2);

                return {
                    className: className, // 直接使用原始班级名称
                    stats: {
                        studentCount: studentData.length,
                        average: averageScore,
                        passCount,
                        passRate,
                        excellentCount,
                        excellentRate,
                        lowScoreCount,
                        lowScoreRate,
                        highestScore,
                        lowestScore
                    }
                };
            });

            // 生成表格
            output += `<table class="statistics-table">
                <tr>
                    <th style="width: 10%;">年级班级</th>
                    <th style="width: 8%;">实考人数</th>
                    <th style="width: 8%;">平均分</th>
                    <th style="width: 8%;">及格人数</th>
                    <th style="width: 8%;">及格率</th>
                    <th style="width: 8%;">优秀人数</th>
                    <th style="width: 8%;">优秀率</th>
                    <th style="width: 8%;">低分人数</th>
                    <th style="width: 8%;">低分率</th>
                    <th style="width: 8%;">最高分</th>
                    <th style="width: 8%;">最低分</th>
                    <th style="width: 10%;">任课教师</th>
                </tr>`;

            // 按顺序添加班级数据
            classStats.forEach(({className, stats}) => {
                output += `<tr>
                    <td>${className}</td>
                    <td>${stats.studentCount}</td>
                    <td>${stats.average}</td>
                    <td>${stats.passCount}</td>
                    <td>${stats.passRate}%</td>
                    <td>${stats.excellentCount}</td>
                    <td>${stats.excellentRate}%</td>
                    <td>${stats.lowScoreCount}</td>
                    <td>${stats.lowScoreRate}%</td>
                    <td>${stats.highestScore}</td>
                    <td>${stats.lowestScore}</td>
                    <td>${teacher}</td>
                </tr>`;
            });

            // 添加统计行
            const totalAverage = (totalScore / totalStudents).toFixed(2);
            const totalPassRate = ((totalPassCount / totalStudents) * 100).toFixed(2);
            const totalExcellentRate = ((totalExcellentCount / totalStudents) * 100).toFixed(2);
            const totalLowScoreRate = ((totalLowScoreCount / totalStudents) * 100).toFixed(2);

            output += `<tr>
                <td>统计</td>
                <td>${totalStudents}</td>
                <td>${totalAverage}</td>
                <td>${totalPassCount}</td>
                <td>${totalPassRate}%</td>
                <td>${totalExcellentCount}</td>
                <td>${totalExcellentRate}%</td>
                <td>${totalLowScoreCount}</td>
                <td>${totalLowScoreRate}%</td>
                <td>${overallHighest}</td>
                <td>${overallLowest}</td>
                <td>${teacher}</td>
            </tr>`;

            output += '</table>';
            
            // 修改底部说明文字，移除统计人
            output += `
                <div class="footer-note">
                    <div style="margin-top: 15px; margin-left: 2px;">备注：优秀率：各学科卷面总分的85%以上（含85%），低分率：各学科卷面总分的30%以下（不含30%）</div>
                </div>
            </div>`;
            
            return output;
        }

        function sortClassNames(classes) {
            return classes.sort((a, b) => {
                // 从班级名称中提取数字
                const numA = parseInt(a.match(/\d+/)[0]);
                const numB = parseInt(b.match(/\d+/)[0]);
                return numA - numB;
            });
        }

        function updateExamNumber() {
            const examType = document.getElementById('exam').value;
            const examNumberGroup = document.getElementById('examNumberGroup');
            const customExamGroup = document.getElementById('customExamGroup');
            
            // 显示/隐藏次数选择
            examNumberGroup.style.display = (examType === '月考' || examType === '模拟') ? 'flex' : 'none';
            
            // 显示/隐藏自定义考试名称输入框
            customExamGroup.style.display = examType === 'custom' ? 'flex' : 'none';
        }

        // 修改获取考试名称的逻辑
        function getExamText() {
            const exam = document.getElementById('exam').value;
            const examNumber = document.getElementById('examNumber').value;
            const customExam = document.getElementById('customExam')?.value;

            if (exam === 'custom') {
                // 如果是自定义考试，直接返回输入的考试名称
                return customExam || '';
            } else if (exam === '月考' || exam === '模拟') {
                return `${exam}（${examNumber}）`;
            } else {
                return exam;
            }
        }

        // 修改班级名称处理函数
        function formatClassName(className) {
            // 直接返回原始班级名称
            return className;
        }

        // 添加导出成绩统计功能
        function handleExportStats() {
            try {
                if (Object.keys(allClassData).length === 0) {
                    alert('请先导入成绩文件');
                    return;
                }

                const year = document.getElementById('year').value || "";
                const school = document.getElementById('school').value || "";
                const term = document.getElementById('term').value || "";
                const subject = document.getElementById('subject').value || "";
                const examText = getExamText();
                const teacher = document.getElementById('teacher').value || "";

                // 创建工作簿
                const wb = XLSX.utils.book_new();
                
                // 准备统计数据
                const statsData = [
                    ['班级', '实考人数', '平均分', '及格人数', '及格率', '优秀人数', '优秀率', 
                     '低分人数', '低分率', '最高分', '最低分', '任课教师']
                ];

                // 计算每个班级的统计数据
                const sortedClasses = sortClassNames(Object.keys(allClassData));
                sortedClasses.forEach(className => {
                    const stats = calculateClassStats(className);
                    statsData.push([
                        formatClassName(className),
                        stats.studentCount,
                        stats.average,
                        stats.passCount,
                        `${stats.passRate}%`,
                        stats.excellentCount,
                        `${stats.excellentRate}%`,
                        stats.lowScoreCount,
                        `${stats.lowScoreRate}%`,
                        stats.highestScore,
                        stats.lowestScore,
                        teacher
                    ]);
                });

                // 添加总计行
                const totalStats = calculateTotalStats();
                statsData.push([
                    '统计',
                    totalStats.totalStudents,
                    totalStats.totalAverage,
                    totalStats.totalPassCount,
                    `${totalStats.totalPassRate}%`,
                    totalStats.totalExcellentCount,
                    `${totalStats.totalExcellentRate}%`,
                    totalStats.totalLowScoreCount,
                    `${totalStats.totalLowScoreRate}%`,
                    totalStats.overallHighest,
                    totalStats.overallLowest,
                    teacher
                ]);

                // 创建工作表
                const ws = XLSX.utils.aoa_to_sheet(statsData);
                
                // 添加工作表到工作簿
                XLSX.utils.book_append_sheet(wb, ws, '成绩统计');
                
                // 导出文件
                XLSX.writeFile(wb, `${year}${school}${term}${examText}${subject}成绩统计.xlsx`);
            } catch (error) {
                console.error('Error:', error);
                alert('导出统计数据时出错：' + error.message);
            }
        }

        // 添加计算班级统计数据的辅助函数
        function calculateClassStats(className) {
            const studentData = allClassData[className];
            let total = 0;
            let passCount = 0;
            let excellentCount = 0;
            let lowScoreCount = 0;
            let highestScore = 0;
            let lowestScore = 100;

            studentData.forEach(row => {
                const score = row[2];
                total += score;
                if (score >= 60) passCount++;
                if (score >= 90) excellentCount++;
                if (score < 30) lowScoreCount++;
                if (score > highestScore) highestScore = score;
                if (score < lowestScore) lowestScore = score;
            });

            return {
                studentCount: studentData.length,
                average: (total / studentData.length).toFixed(2),
                passCount,
                passRate: ((passCount / studentData.length) * 100).toFixed(2),
                excellentCount,
                excellentRate: ((excellentCount / studentData.length) * 100).toFixed(2),
                lowScoreCount,
                lowScoreRate: ((lowScoreCount / studentData.length) * 100).toFixed(2),
                highestScore,
                lowestScore
            };
        }

        // 添加计算总计统计数据的辅助函数
        function calculateTotalStats() {
            let totalStudents = 0;
            let totalScore = 0;
            let totalPassCount = 0;
            let totalExcellentCount = 0;
            let totalLowScoreCount = 0;
            let overallHighest = 0;
            let overallLowest = 100;

            Object.keys(allClassData).forEach(className => {
                const stats = calculateClassStats(className);
                totalStudents += stats.studentCount;
                totalScore += stats.studentCount * parseFloat(stats.average);
                totalPassCount += stats.passCount;
                totalExcellentCount += stats.excellentCount;
                totalLowScoreCount += stats.lowScoreCount;
                overallHighest = Math.max(overallHighest, stats.highestScore);
                overallLowest = Math.min(overallLowest, stats.lowestScore);
            });

            return {
                totalStudents,
                totalAverage: (totalScore / totalStudents).toFixed(2),
                totalPassCount,
                totalPassRate: ((totalPassCount / totalStudents) * 100).toFixed(2),
                totalExcellentCount,
                totalExcellentRate: ((totalExcellentCount / totalStudents) * 100).toFixed(2),
                totalLowScoreCount,
                totalLowScoreRate: ((totalLowScoreCount / totalStudents) * 100).toFixed(2),
                overallHighest,
                overallLowest
            };
        }
    </script>
</body>
</html>